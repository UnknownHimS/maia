<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Learning Hub</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: white;
            font-size: 2.5em;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .btn {
            background: white;
            border: none;
            border-radius: 20px;
            padding: 40px 20px;
            font-size: 1.5em;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            min-height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .btn-doctor { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .btn-youtube { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .btn-math { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .btn-assistant { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .btn-game5 { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); }
        .btn-game6 { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            margin: 20px auto;
            padding: 30px;
            border-radius: 20px;
            max-width: 900px;
            position: relative;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 2em;
            cursor: pointer;
            color: #666;
        }

        .close:hover { color: #000; }

        .hospital-scene {
            background: #e8f5e9;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            min-height: 300px;
            position: relative;
        }

        .character {
            font-size: 4em;
            display: inline-block;
            animation: bounce 0.5s;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .speech-bubble {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            font-size: 1.3em;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            position: relative;
        }

        .speech-bubble:before {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 30px;
            border: 10px solid transparent;
            border-top-color: white;
        }

        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 25px 0;
        }

        .tool-btn {
            background: white;
            border: 3px solid #ddd;
            border-radius: 15px;
            padding: 20px;
            font-size: 3em;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .tool-btn:hover {
            transform: scale(1.1);
            border-color: #4facfe;
        }

        .tool-btn.correct {
            background: #c8e6c9;
            border-color: #4caf50;
            animation: shake 0.5s;
        }

        .tool-btn.wrong {
            background: #ffcdd2;
            border-color: #f44336;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .tool-label {
            font-size: 0.3em;
            display: block;
            margin-top: 5px;
        }

        .control-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            margin: 10px 5px;
            transition: background 0.3s;
        }

        .control-btn:hover { background: #5568d3; }
        .control-btn:disabled { background: #ccc; cursor: not-allowed; }

        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin: 10px 0;
        }

        .video-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .video-wrapper {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
        }

        .video-wrapper iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 10px;
        }

        .instrument-btn {
            padding: 20px 30px;
            margin: 8px;
            font-size: 1.3em;
            border: 3px solid #333;
            border-radius: 10px;
            cursor: pointer;
            background: white;
            transition: all 0.1s;
            font-weight: bold;
            box-shadow: 0 4px 0 #666;
        }

        .instrument-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #666;
        }

        .piano-key {
            background: white;
            border: 2px solid #000;
        }

        .drum-btn {
            background: #ff6b6b;
            color: white;
            border-color: #c92a2a;
        }

        .link-list {
            list-style: none;
        }

        .link-list li {
            margin: 15px 0;
        }

        .link-list a {
            display: block;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 10px;
            text-decoration: none;
            color: #333;
            transition: background 0.3s;
        }

        .link-list a:hover { background: #e0e0e0; }

        .score {
            font-size: 1.5em;
            color: #667eea;
            font-weight: bold;
            margin: 15px 0;
        }

        .recording-indicator {
            display: inline-block;
            width: 15px;
            height: 15px;
            background: red;
            border-radius: 50%;
            animation: blink 1s infinite;
            margin-left: 10px;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        @media (max-width: 768px) {
            h1 { font-size: 1.8em; }
            .btn { font-size: 1.2em; padding: 30px 15px; }
            .modal-content { padding: 20px; }
            .character { font-size: 3em; }
            .tool-btn { font-size: 2em; }
        }

        .patient-status {
            font-size: 1.5em;
            text-align: center;
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            font-weight: bold;
        }

        .status-sick { background: #ffebee; color: #c62828; }
        .status-treating { background: #fff3e0; color: #e65100; }
        .status-happy { background: #e8f5e9; color: #2e7d32; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåü Interactive Learning Hub üåü</h1>
        
        <div class="grid">
            <button class="btn btn-doctor" onclick="openModal('doctor')">
                <span style="font-size: 2em;">üë©‚Äç‚öïÔ∏è</span>
                <span>Doctor Game</span>
            </button>
            <button class="btn btn-youtube" onclick="openModal('youtube')">
                <span style="font-size: 2em;">üì∫</span>
                <span>YouTube Room</span>
            </button>
            <button class="btn btn-math" onclick="openModal('math')">
                <span style="font-size: 2em;">‚ûï‚úñÔ∏è</span>
                <span>Math Trainer</span>
            </button>
            <button class="btn btn-assistant" onclick="openModal('assistant')">
                <span style="font-size: 2em;">ü§ñ</span>
                <span>Assistant</span>
            </button>
            <button class="btn btn-game5" onclick="openModal('game5')">
                <span style="font-size: 2em;">üéÆ</span>
                <span>Game 5</span>
            </button>
            <button class="btn btn-game6" onclick="openModal('game6')">
                <span style="font-size: 2em;">üåç</span>
                <span>Fun Facts</span>
            </button>
        </div>
    </div>

    <!-- Doctor Modal -->
    <div id="doctorModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('doctor')">&times;</span>
            <h2>üë©‚Äç‚öïÔ∏è Doctor Game - Help the Patient!</h2>
            
            <div class="hospital-scene">
                <div style="text-align: center;">
                    <span id="patientEmoji" class="character">ü§ï</span>
                    <span id="doctorEmoji" class="character" style="margin-left: 30px;">üë®‚Äç‚öïÔ∏è</span>
                </div>
                
                <div id="patientStatus" class="patient-status status-sick">
                    Patient needs help!
                </div>
                
                <div id="doctorSpeech" class="speech-bubble">
                    Click "Start New Patient" to help someone!
                </div>
            </div>

            <div id="toolsSection" style="display: none;">
                <h3 style="text-align: center; margin: 20px 0;">Pick the right tool to help!</h3>
                <div class="tools-grid" id="toolsGrid"></div>
            </div>

            <div style="text-align: center;">
                <button class="control-btn" onclick="startNewPatient()">Start New Patient</button>
            </div>
        </div>
    </div>

    <!-- YouTube Modal -->
    <div id="youtubeModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('youtube')">&times;</span>
            <h2>üì∫ YouTube Room</h2>
            
            <div class="video-container">
                <div class="video-wrapper">
                    <iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ" allowfullscreen></iframe>
                </div>
                <div class="video-wrapper">
                    <iframe src="https://www.youtube.com/embed/kJQP7kiw5Fk" allowfullscreen></iframe>
                </div>
                <div class="video-wrapper">
                    <iframe src="https://www.youtube.com/embed/9bZkp7q19f0" allowfullscreen></iframe>
                </div>
            </div>

            <h3>üéπ Play Piano</h3>
            <div id="piano" style="text-align: center;"></div>
            
            <h3 style="margin-top: 30px;">ü•Å Play Drums</h3>
            <div id="drums" style="text-align: center;"></div>

            <h3 style="margin-top: 30px;">üìπ Record Yourself</h3>
            <video id="videoPreview" width="100%" style="max-width: 500px; border-radius: 10px; display: none;"></video>
            <div style="text-align: center;">
                <button class="control-btn" onclick="startRecording()">üî¥ Start Recording</button>
                <button class="control-btn" onclick="stopRecording()">‚èπÔ∏è Stop Recording</button>
                <p id="recordingStatus"></p>
            </div>
        </div>
    </div>

    <!-- Math Modal -->
    <div id="mathModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('math')">&times;</span>
            <h2>‚ûï‚úñÔ∏è Math Trainer</h2>
            <div class="score">Score: <span id="mathScore">0</span></div>
            <div id="mathQuestion" style="font-size: 1.5em; margin: 20px 0;"></div>
            <input type="number" id="mathAnswer" placeholder="Your answer">
            <div>
                <button class="control-btn" onclick="generateQuestion()">New Question</button>
                <button class="control-btn" onclick="checkAnswer()">Check Answer</button>
                <button class="control-btn" onclick="speakQuestion()">üîä Hear Question</button>
            </div>
            <div id="mathFeedback" style="margin-top: 20px; font-size: 1.2em;"></div>
        </div>
    </div>

    <!-- Assistant Modal -->
    <div id="assistantModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('assistant')">&times;</span>
            <h2>ü§ñ Assistant Links</h2>
            <ul class="link-list">
                <li><a href="https://www.google.com" target="_blank">üîç Google Search</a></li>
                <li><a href="https://www.wikipedia.org" target="_blank">üìö Wikipedia</a></li>
                <li><a href="https://www.khanacademy.org" target="_blank">üìñ Khan Academy</a></li>
                <li><a href="https://www.duolingo.com" target="_blank">üó£Ô∏è Duolingo</a></li>
                <li><a href="https://www.codecademy.com" target="_blank">üíª Codecademy</a></li>
                <li><a href="https://www.nasa.gov/kidsclub" target="_blank">üöÄ NASA Kids Club</a></li>
            </ul>
        </div>
    </div>

    <!-- Game 5 Modal -->
    <div id="game5Modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('game5')">&times;</span>
            <h2>üéÆ Game 5</h2>
            <div style="text-align: center; padding: 50px;">
                <h1 style="font-size: 3em;">üöß</h1>
                <h3>Coming Soon!</h3>
                <p style="margin-top: 20px; font-size: 1.2em;">Exciting games are on the way!</p>
            </div>
        </div>
    </div>

    <!-- Game 6 Modal -->
    <div id="game6Modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('game6')">&times;</span>
            <h2>üåç Fun Facts</h2>
            <div id="funFact" style="font-size: 1.3em; text-align: center; padding: 30px; background: #f0f0f0; border-radius: 15px;"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="control-btn" onclick="generateFunFact()">Get New Fact</button>
                <button class="control-btn" onclick="speakFunFact()">üîä Hear Fact</button>
            </div>
        </div>
    </div>

    <script>
        // Storage
        const storage = {
            mathScore: 0,
            recordings: []
        };

        let currentQuestion = {};
        let mediaRecorder;
        let recordedChunks = [];
        let currentFact = '';
        let currentCase = null;
        let audioContext;

        // Speech
        function speak(text, callback) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.85;
            utterance.pitch = 1.1;
            if (callback) utterance.onend = callback;
            speechSynthesis.speak(utterance);
        }

        // Modal Controls
        function openModal(type) {
            document.getElementById(type + 'Modal').style.display = 'block';
            if (type === 'youtube') initInstruments();
            if (type === 'game6') generateFunFact();
        }

        function closeModal(type) {
            document.getElementById(type + 'Modal').style.display = 'none';
            speechSynthesis.cancel();
        }

        // Doctor Game - Medical Cases
        const medicalCases = [
            {
                problem: "The patient has a cut on their arm and it's bleeding!",
                patientEmoji: "ü§ï",
                correctTool: "üíâ",
                correctName: "Needle",
                wrongResponse: "That's not right! We need something to clean and close the cut.",
                correctResponse: "Yes! Good job! Now I will clean the cut and give medicine.",
                treatment: "I'm cleaning the cut with medicine... Now putting a bandage... All done!",
                happyEmoji: "üòä"
            },
            {
                problem: "The patient has a very high fever! Their body is too hot!",
                patientEmoji: "ü•µ",
                correctTool: "üíä",
                correctName: "Medicine",
                wrongResponse: "No, that won't help with fever. Try again!",
                correctResponse: "Perfect! This medicine will make the fever go away!",
                treatment: "Here, drink this medicine with water... Good! Now rest and you'll feel better soon!",
                happyEmoji: "üòå"
            },
            {
                problem: "The patient broke their leg! The bone is hurt inside!",
                patientEmoji: "üò£",
                correctTool: "ü©π",
                correctName: "Bandage",
                wrongResponse: "That won't fix a broken bone. What else can we use?",
                correctResponse: "Great choice! We need to wrap the leg so it can heal!",
                treatment: "I'm wrapping the leg carefully... Making it stable... Perfect! Don't walk for a few weeks!",
                happyEmoji: "üòä"
            },
            {
                problem: "The patient's stomach hurts a lot! They ate too much candy!",
                patientEmoji: "ü§¢",
                correctTool: "üíä",
                correctName: "Medicine",
                wrongResponse: "Hmm, that's not what we need for a tummy ache!",
                correctResponse: "Exactly right! This will help the stomach feel better!",
                treatment: "Take this medicine... Drink some water... No more candy today! Rest your tummy!",
                happyEmoji: "üòä"
            },
            {
                problem: "The patient has a bad cough and can't breathe well!",
                patientEmoji: "üò∑",
                correctTool: "üíâ",
                correctName: "Needle",
                wrongResponse: "Not quite! We need something to help them breathe better.",
                correctResponse: "Yes! I'll give them medicine to open up their breathing!",
                treatment: "Giving the medicine shot... Take deep breaths... Inhale... Exhale... Much better!",
                happyEmoji: "üòä"
            },
            {
                problem: "The patient hit their head and has a big bump!",
                patientEmoji: "ü§ï",
                correctTool: "üßä",
                correctName: "Ice",
                wrongResponse: "That won't help with the bump. What makes bumps smaller?",
                correctResponse: "Smart! Ice will make the bump go down!",
                treatment: "Putting ice on the bump... Hold it there... The cold makes swelling go away! All better!",
                happyEmoji: "üòä"
            },
            {
                problem: "The patient's tooth hurts really bad!",
                patientEmoji: "üòñ",
                correctTool: "üíä",
                correctName: "Medicine",
                wrongResponse: "That won't stop the tooth pain. Try another tool!",
                correctResponse: "Good! This medicine stops tooth pain!",
                treatment: "Here's medicine for the pain... Now let me check the tooth... We might need to see a dentist!",
                happyEmoji: "üòä"
            },
            {
                problem: "The patient has an ear infection! Their ear hurts!",
                patientEmoji: "üò£",
                correctTool: "üíß",
                correctName: "Drops",
                wrongResponse: "That won't help the ear. What goes inside ears?",
                correctResponse: "Perfect! Ear drops will fix the infection!",
                treatment: "Putting drops in your ear... Stay still... Let it go deep inside... Done! No more pain soon!",
                happyEmoji: "üòä"
            },
            {
                problem: "The patient's eyes are red and itchy from allergies!",
                patientEmoji: "üòñ",
                correctTool: "üíß",
                correctName: "Drops",
                wrongResponse: "Not right for itchy eyes. What helps eyes feel better?",
                correctResponse: "Excellent! Eye drops will stop the itching!",
                treatment: "Look up please... Dropping medicine in your eyes... Blink blink... Much better now!",
                happyEmoji: "üòä"
            },
            {
                problem: "The patient is very dehydrated! They need water in their body fast!",
                patientEmoji: "üòµ",
                correctTool: "üíâ",
                correctName: "Needle",
                wrongResponse: "That won't get water in fast enough. Try again!",
                correctResponse: "Yes! We'll use an IV to give water through the needle!",
                treatment: "Putting the needle in... Connecting the water bag... Water going in your veins... You'll feel better soon!",
                happyEmoji: "üòä"
            },
            {
                problem: "The patient sprained their ankle playing! It's swollen!",
                patientEmoji: "üò£",
                correctTool: "üßä",
                correctName: "Ice",
                wrongResponse: "That won't reduce the swelling. What makes swelling go down?",
                correctResponse: "Right! Ice and rest will fix that ankle!",
                treatment: "Icing the ankle... Wrapping it up... Keep it up high... No running for a week!",
                happyEmoji: "üòä"
            },
            {
                problem: "The patient has a rash that's red and itchy all over!",
                patientEmoji: "üòñ",
                correctTool: "üíä",
                correctName: "Medicine",
                wrongResponse: "That won't stop the itching. What helps rashes?",
                correctResponse: "Good thinking! This cream medicine stops itching!",
                treatment: "Putting cream on the rash... Rub it in gently... Don't scratch! It will go away in a few days!",
                happyEmoji: "üòä"
            }
        ];

        const medicalTools = [
            { emoji: "üíâ", name: "Needle" },
            { emoji: "üíä", name: "Medicine" },
            { emoji: "ü©π", name: "Bandage" },
            { emoji: "üßä", name: "Ice" },
            { emoji: "üíß", name: "Drops" },
            { emoji: "üå°Ô∏è", name: "Thermometer" }
        ];

        function startNewPatient() {
            currentCase = medicalCases[Math.floor(Math.random() * medicalCases.length)];
            
            document.getElementById('patientEmoji').textContent = currentCase.patientEmoji;
            document.getElementById('patientStatus').textContent = 'Patient needs help!';
            document.getElementById('patientStatus').className = 'patient-status status-sick';
            document.getElementById('doctorSpeech').textContent = currentCase.problem;
            
            speak(currentCase.problem, () => {
                setTimeout(() => {
                    const askForTool = `Quick! What tool should I use? Pick one!`;
                    document.getElementById('doctorSpeech').textContent = askForTool;
                    speak(askForTool);
                    showTools();
                }, 1500);
            });
        }

        function showTools() {
            document.getElementById('toolsSection').style.display = 'block';
            const grid = document.getElementById('toolsGrid');
            grid.innerHTML = '';
            
            medicalTools.forEach(tool => {
                const btn = document.createElement('button');
                btn.className = 'tool-btn';
                btn.innerHTML = tool.emoji + '<span class="tool-label">' + tool.name + '</span>';
                btn.onclick = () => selectTool(tool.emoji, tool.name);
                grid.appendChild(btn);
            });
        }

        function selectTool(emoji, name) {
            if (!currentCase) return;
            
            const buttons = document.querySelectorAll('.tool-btn');
            buttons.forEach(btn => btn.style.pointerEvents = 'none');
            
            if (emoji === currentCase.correctTool) {
                event.target.classList.add('correct');
                document.getElementById('patientStatus').textContent = 'Treating patient...';
                document.getElementById('patientStatus').className = 'patient-status status-treating';
                document.getElementById('doctorSpeech').textContent = currentCase.correctResponse;
                
                speak(currentCase.correctResponse, () => {
                    setTimeout(() => {
                        document.getElementById('doctorSpeech').textContent = currentCase.treatment;
                        speak(currentCase.treatment, () => {
                            setTimeout(() => {
                                document.getElementById('patientEmoji').textContent = currentCase.happyEmoji;
                                document.getElementById('patientStatus').textContent = 'Patient is all better! üéâ';
                                document.getElementById('patientStatus').className = 'patient-status status-happy';
                                const happy = "The patient is happy and healthy now! Great job, doctor!";
                                document.getElementById('doctorSpeech').textContent = happy;
                                speak(happy);
                                document.getElementById('toolsSection').style.display = 'none';
                            }, 2000);
                        });
                    }, 1500);
                });
            } else {
                event.target.classList.add('wrong');
                document.getElementById('doctorSpeech').textContent = currentCase.wrongResponse;
                speak(currentCase.wrongResponse, () => {
                    setTimeout(() => {
                        event.target.classList.remove('wrong');
                        buttons.forEach(btn => btn.style.pointerEvents = 'auto');
                    }, 2000);
                });
            }
        }

        // Audio Context for Instruments
        function getAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioContext;
        }

        function playPiano(frequency) {
            const ctx = getAudioContext();
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);
            
            oscillator.type = 'triangle';
            oscillator.frequency.value = frequency;
            
            gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 1.0);
            
            oscillator.start(ctx.currentTime);
            oscillator.stop(ctx.currentTime + 1.0);
        }

        function playDrum(type) {
            const ctx = getAudioContext();
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            const filter = ctx.createBiquadFilter();
            
            oscillator.connect(filter);
            filter.connect(gainNode);
            gainNode.connect(ctx.destination);
            
            if (type === 'kick') {
                oscillator.frequency.setValueAtTime(150, ctx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(1, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + 0.5);
            } else if (type === 'snare') {
                const noise = ctx.createBufferSource();
                const buffer = ctx.createBuffer(1, ctx.sampleRate * 0.2, ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < buffer.length; i++) {
                    data[i] = Math.random() * 2 - 1;
                }
                noise.buffer = buffer;
                noise.connect(filter);
                filter.type = 'highpass';
                filter.frequency.value = 1000;
                gainNode.gain.setValueAtTime(0.7, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                noise.start(ctx.currentTime);
                noise.stop(ctx.currentTime + 0.2);
            } else if (type === 'hihat') {
                const noise = ctx.createBufferSource();
                const buffer = ctx.createBuffer(1, ctx.sampleRate * 0.1, ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < buffer.length; i++) {
                    data[i] = Math.random() * 2 - 1;
                }
                noise.buffer = buffer;
                noise.connect(filter);
                filter.type = 'highpass';
                filter.frequency.value = 7000;
                gainNode.gain.setValueAtTime(0.5, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                noise.start(ctx.currentTime);
                noise.stop(ctx.currentTime + 0.1);
            }
        }

        function initInstruments() {
            const pianoNotes = [
                { note: 'C', freq: 261.63 },
                { note: 'D', freq: 293.66 },
                { note: 'E', freq: 329.63 },
                { note: 'F', freq: 349.23 },
                { note: 'G', freq: 392.00 },
                { note: 'A', freq: 440.00 },
                { note: 'B', freq: 493.88 },
                { note: 'C2', freq: 523.25 }
            ];

            const pianoDiv = document.getElementById('piano');
            pianoDiv.innerHTML = '';
            pianoNotes.forEach(n => {
                const btn = document.createElement('button');
                btn.className = 'instrument-btn piano-key';
                btn.textContent = n.note;
                btn.onclick = () => playPiano(n.freq);
                pianoDiv.appendChild(btn);
            });

            const drumsDiv = document.getElementById('drums');
            drumsDiv.innerHTML = '';
            const drums = [
                { name: 'KICK ü•Å', type: 'kick' },
                { name: 'SNARE üéµ', type: 'snare' },
                { name: 'HI-HAT üîî', type: 'hihat' }
            ];
            drums.forEach(d => {
                const btn = document.createElement('button');
                btn.className = 'instrument-btn drum-btn';
                btn.textContent = d.name;
                btn.onclick = () => playDrum(d.type);
                drumsDiv.appendChild(btn);
            });
        }

        // Recording
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                const video = document.getElementById('videoPreview');
                video.srcObject = stream;
                video.style.display = 'block';
                video.play();

                recordedChunks = [];
                mediaRecorder = new MediaRecorder(stream);
                
                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) recordedChunks.push(e.data);
                };

                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    storage.recordings.push({ url, date: new Date().toISOString() });
                    document.getElementById('recordingStatus').textContent = '‚úÖ Recording saved!';
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                document.getElementById('recordingStatus').innerHTML = 'Recording<span class="recording-indicator"></span>';
            } catch (err) {
                alert('Could not access camera: ' + err.message);
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                document.getElementById('videoPreview').style.display = 'none';
            }
        }

        // Math Trainer
        function generateQuestion() {
            const types = ['addition', 'multiplication', 'algebra'];
            const type = types[Math.floor(Math.random() * types.length)];
            
            let question, answer;
            
            if (type === 'addition') {
                const a = Math.floor(Math.random() * 50) + 1;
                const b = Math.floor(Math.random() * 50) + 1;
                question = `${a} plus ${b}`;
                answer = a + b;
            } else if (type === 'multiplication') {
                const a = Math.floor(Math.random() * 12) + 1;
                const b = Math.floor(Math.random() * 12) + 1;
                question = `${a} times ${b}`;
                answer = a * b;
            } else {
                const x = Math.floor(Math.random() * 10) + 1;
                const b = Math.floor(Math.random() * 20) + 1;
                const c = x + b;
                question = `x plus ${b} equals ${c}. What is x?`;
                answer = x;
            }
            
            currentQuestion = { question, answer };
            document.getElementById('mathQuestion').textContent = question;
            document.getElementById('mathAnswer').value = '';
            document.getElementById('mathFeedback').innerHTML = '';
        }

        function checkAnswer() {
            const userAnswer = parseInt(document.getElementById('mathAnswer').value);
            const feedback = document.getElementById('mathFeedback');
            
            if (userAnswer === currentQuestion.answer) {
                storage.mathScore++;
                document.getElementById('mathScore').textContent = storage.mathScore;
                feedback.innerHTML = '‚úÖ Correct! Great job!';
                feedback.style.color = 'green';
                speak('Correct! Great job!');
            } else {
                feedback.innerHTML = `‚ùå Not quite. The answer is ${currentQuestion.answer}. Let me explain...`;
                feedback.style.color = 'red';
                explainAnswer();
            }
        }

        function explainAnswer() {
            const q = currentQuestion.question;
            let explanation = '';
            
            if (q.includes('plus')) {
                const parts = q.match(/\d+/g).map(Number);
                explanation = `When we add ${parts[0]} and ${parts[1]}, we start at ${parts[0]} and count up ${parts[1]} times. The answer is ${currentQuestion.answer}.`;
            } else if (q.includes('times')) {
                const parts = q.match(/\d+/g).map(Number);
                explanation = `${parts[0]} times ${parts[1]} means we have ${parts[1]} groups of ${parts[0]}. That equals ${currentQuestion.answer}.`;
            } else {
                explanation = `The answer is ${currentQuestion.answer}. We need to find what number plus the other number gives us the total!`;
            }
            
            speak(explanation);
            document.getElementById('mathFeedback').innerHTML += `<br><br>${explanation}`;
        }

        function speakQuestion() {
            speak(currentQuestion.question);
        }

        // Fun Facts
        const funFacts = [
            "Octopuses have three hearts! Two hearts pump blood to the gills, and one heart pumps blood to the rest of the body!",
            "Honey never spoils! People found 3000-year-old honey in Egyptian tombs and it was still good to eat!",
            "A group of flamingos is called a flamboyance! That's a fancy word that means very colorful and showy!",
            "Bananas are berries, but strawberries are not berries! Isn't that surprising?",
            "A day on Venus is longer than a year on Venus! Venus spins very slowly but moves around the sun faster!",
            "There are more stars in the universe than grains of sand on all of Earth's beaches! That's a huge number!",
            "Butterflies taste with their feet! They stand on their food to know if it's good to eat!",
            "A lightning bolt is five times hotter than the surface of the sun! Lightning is super hot!",
            "Sharks have been around longer than trees! Sharks are more than 400 million years old!",
            "A group of owls is called a parliament! That sounds very wise and important!",
            "Cows have best friends! They get stressed when they are separated from their best friend!",
            "The heart of a shrimp is in its head! How weird is that?",
            "Penguins propose to each other with pebbles! A male penguin gives a special pebble to the female penguin he loves!"
        ];

        function generateFunFact() {
            currentFact = funFacts[Math.floor(Math.random() * funFacts.length)];
            document.getElementById('funFact').textContent = currentFact;
        }

        function speakFunFact() {
            speak(currentFact);
        }

        // Initialize
        generateQuestion();
    </script>
</body>
</html>
