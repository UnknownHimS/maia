<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTA Emoji World - Doctor Life</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            background: #1a1a1a;
        }

        #gameCanvas {
            display: block;
            background: #2d5016;
            image-rendering: crisp-edges;
        }

        #ui {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 100;
            border: 2px solid #4CAF50;
        }

        #money {
            color: #4CAF50;
            font-weight: bold;
            font-size: 18px;
        }

        #hungerBar {
            width: 200px;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
            border: 2px solid #666;
        }

        #hungerFill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s, background 0.3s;
        }

        #hungerFill.low {
            background: linear-gradient(90deg, #FF9800, #FFC107);
        }

        #hungerFill.critical {
            background: linear-gradient(90deg, #F44336, #E91E63);
            animation: blink 0.5s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        #minimap {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 150px;
            height: 150px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #4CAF50;
            border-radius: 10px;
            z-index: 100;
        }

        #controls {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 10px;
            font-size: 12px;
            border: 2px solid #4CAF50;
        }

        #actionBtn {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 10px;
            cursor: pointer;
            display: none;
            z-index: 100;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            display: none;
            z-index: 200;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #ddd;
            margin-bottom: 10px;
        }

        .shop-item button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        .close-btn {
            margin-top: 15px;
            width: 100%;
            padding: 10px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #hospitalInterior, #churchInterior, #homeInterior {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 150;
        }

        #hospitalInterior {
            background: #e8f5e9;
        }

        #churchInterior {
            background: linear-gradient(180deg, #1a237e, #3949ab);
        }

        #homeInterior {
            background: linear-gradient(180deg, #ffeaa7, #fdcb6e);
        }

        .interior-ui {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #4CAF50;
        }

        .exit-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #f44336;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 10px;
            cursor: pointer;
        }

        #patientList {
            position: absolute;
            top: 120px;
            left: 20px;
            right: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .patient-bed {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 3px solid #2196F3;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .patient-bed:hover {
            transform: scale(1.05);
        }

        .patient-bed.treated {
            border-color: #4CAF50;
            background: #c8e6c9;
        }

        #treatmentPanel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            display: none;
            z-index: 250;
            box-shadow: 0 0 30px rgba(0,0,0,0.7);
            max-width: 600px;
        }

        .tool-option {
            padding: 15px;
            margin: 10px 0;
            background: #f5f5f5;
            border-radius: 10px;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .tool-option:hover {
            background: #e3f2fd;
            border-color: #2196F3;
        }

        .tool-option.correct {
            background: #c8e6c9;
            border-color: #4CAF50;
        }

        .tool-option.wrong {
            background: #ffcdd2;
            border-color: #f44336;
        }

        #churchContent {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            max-width: 700px;
            padding: 40px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
        }

        #bibleVerse {
            font-size: 24px;
            font-style: italic;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        #verseReference {
            font-size: 18px;
            font-weight: bold;
            color: #FFD700;
        }

        #homeContent {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 900px;
        }

        .room-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 3px solid #ff6b6b;
        }

        .character {
            display: inline-block;
            font-size: 80px;
            margin: 20px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .character:hover {
            transform: scale(1.1);
        }

        #mobileControls {
            position: fixed;
            bottom: 80px;
            right: 10px;
            display: none;
            z-index: 100;
        }

        .control-pad {
            display: grid;
            grid-template-columns: repeat(3, 60px);
            grid-template-rows: repeat(3, 60px);
            gap: 5px;
        }

        .control-btn {
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: 2px solid #4CAF50;
            border-radius: 10px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (max-width: 768px) {
            #mobileControls {
                display: block;
            }
            #controls {
                display: none;
            }
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <canvas id="minimap"></canvas>
    
    <div id="ui">
        <div>Dr. <span id="playerIcon">üë®‚Äç‚öïÔ∏è</span></div>
        <div id="money">Money: $100</div>
        <div>Hunger: <span id="hungerText">100%</span></div>
        <div id="hungerBar">
            <div id="hungerFill" style="width: 100%"></div>
        </div>
        <div>Patients Treated: <span id="patientCount">0</span></div>
        <div>Speed: <span id="speed">Walking</span></div>
    </div>

    <div id="controls">
        <div>üéÆ WASD or Arrow Keys to move</div>
        <div>E - Interact when near objects</div>
        <div>SHIFT - Run faster</div>
    </div>

    <button id="actionBtn">Press E</button>

    <div id="shop" class="modal">
        <h2>üè™ Supermarket</h2>
        <div class="shop-item">
            <span>üçï Pizza - $10 (+30 hunger)</span>
            <button onclick="buyFood('üçï Pizza', 10, 30)">Buy</button>
        </div>
        <div class="shop-item">
            <span>üçî Burger - $8 (+25 hunger)</span>
            <button onclick="buyFood('üçî Burger', 8, 25)">Buy</button>
        </div>
        <div class="shop-item">
            <span>ü•§ Soda - $3 (+10 hunger)</span>
            <button onclick="buyFood('ü•§ Soda', 3, 10)">Buy</button>
        </div>
        <div class="shop-item">
            <span>üçé Apple - $2 (+15 hunger)</span>
            <button onclick="buyFood('üçé Apple', 2, 15)">Buy</button>
        </div>
        <div class="shop-item">
            <span>üçó Chicken - $12 (+40 hunger)</span>
            <button onclick="buyFood('üçó Chicken', 12, 40)">Buy</button>
        </div>
        <button class="close-btn" onclick="closeShop()">Close</button>
    </div>

    <div id="hospitalInterior">
        <div class="interior-ui">
            <h2>üè• City Hospital - Doctor's Shift</h2>
            <p>Click on patients to diagnose and treat them!</p>
            <p>Earn $50 for each patient treated correctly.</p>
        </div>
        <button class="exit-btn" onclick="exitHospital()">Exit Hospital</button>
        <div id="patientList"></div>
    </div>

    <div id="treatmentPanel">
        <h2 id="patientProblem">Patient Problem</h2>
        <p id="patientDescription"></p>
        <h3>Select the correct medical tool:</h3>
        <div id="toolOptions"></div>
        <button class="close-btn" onclick="closeTreatment()">Cancel</button>
    </div>

    <div id="churchInterior">
        <div id="churchContent">
            <h1 style="font-size: 48px; margin-bottom: 30px;">‚õ™ Church</h1>
            <div id="bibleVerse"></div>
            <div id="verseReference"></div>
            <button style="margin-top: 30px; padding: 15px 30px; font-size: 18px; border-radius: 10px; border: none; background: #FFD700; cursor: pointer;" onclick="getNewVerse()">
                üìñ New Verse
            </button>
        </div>
        <button class="exit-btn" onclick="exitChurch()">Exit Church</button>
    </div>

    <div id="homeInterior">
        <div id="homeContent">
            <div class="room-section">
                <h2>üè† Your Home - Living Room</h2>
                <div style="text-align: center;">
                    <div class="character" onclick="talkToDad()">
                        üë® Dad
                        <div style="font-size: 14px;">Relaxing on couch</div>
                    </div>
                </div>
            </div>
            <div class="room-section">
                <h2>üç≥ Kitchen</h2>
                <div style="text-align: center;">
                    <div class="character" onclick="talkToMom()">
                        üë©‚Äçüç≥ Mom
                        <div style="font-size: 14px;">Cooking delicious food</div>
                    </div>
                    <button style="margin: 20px; padding: 15px 30px; font-size: 18px; border-radius: 10px; background: #4CAF50; color: white; border: none; cursor: pointer;" onclick="getMomFood()">
                        üçΩÔ∏è Ask for Food
                    </button>
                </div>
            </div>
        </div>
        <button class="exit-btn" onclick="exitHome()">Exit Home</button>
    </div>

    <div id="mobileControls">
        <div class="control-pad">
            <div></div>
            <button class="control-btn" data-dir="up">‚Üë</button>
            <div></div>
            <button class="control-btn" data-dir="left">‚Üê</button>
            <div></div>
            <button class="control-btn" data-dir="right">‚Üí</button>
            <div></div>
            <button class="control-btn" data-dir="down">‚Üì</button>
            <div></div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const minimapCanvas = document.getElementById('minimap');
        const minimapCtx = minimapCanvas.getContext('2d');
        
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const TILE_SIZE = 50;
        const WORLD_WIDTH = 60;
        const WORLD_HEIGHT = 60;

        let camera = { x: 0, y: 0 };

        let player = {
            x: 10,
            y: 10,
            emoji: 'üë®‚Äç‚öïÔ∏è',
            speed: 0.15,
            baseSpeed: 0.15,
            inVehicle: false,
            money: 100,
            hunger: 100,
            patientsTreated: 0,
        };

        let keys = {};
        let nearObject = null;
        let currentPatient = null;
        let inHospital = false;
        let inChurch = false;
        let inHome = false;

        // Bible verses
        const bibleVerses = [
            { verse: "For God so loved the world that he gave his one and only Son, that whoever believes in him shall not perish but have eternal life.", ref: "John 3:16" },
            { verse: "The Lord is my shepherd, I lack nothing. He makes me lie down in green pastures, he leads me beside quiet waters.", ref: "Psalm 23:1-2" },
            { verse: "Trust in the Lord with all your heart and lean not on your own understanding.", ref: "Proverbs 3:5" },
            { verse: "I can do all things through Christ who strengthens me.", ref: "Philippians 4:13" },
            { verse: "Be strong and courageous. Do not be afraid; do not be discouraged, for the Lord your God will be with you wherever you go.", ref: "Joshua 1:9" },
            { verse: "The Lord bless you and keep you; the Lord make his face shine on you and be gracious to you.", ref: "Numbers 6:24-25" },
            { verse: "Cast all your anxiety on him because he cares for you.", ref: "1 Peter 5:7" },
            { verse: "Do not be anxious about anything, but in every situation, by prayer and petition, with thanksgiving, present your requests to God.", ref: "Philippians 4:6" },
            { verse: "Love is patient, love is kind. It does not envy, it does not boast, it is not proud.", ref: "1 Corinthians 13:4" },
            { verse: "And we know that in all things God works for the good of those who love him.", ref: "Romans 8:28" }
        ];

        // Medical cases
        const medicalCases = [
            {
                problem: "Broken Arm",
                emoji: "ü§ï",
                description: "Patient fell and has severe pain in left arm. Visible deformity and swelling.",
                correctTool: "ü©π Cast & X-Ray",
                tools: ["ü©π Cast & X-Ray", "üíä Medicine", "üíâ Injection", "üå°Ô∏è Thermometer"],
                instructor: "This patient has a fracture. You need to take an X-ray and apply a cast!"
            },
            {
                problem: "High Fever",
                emoji: "ü§í",
                description: "Patient has temperature of 103¬∞F, complaining of body aches and chills.",
                correctTool: "üíä Fever Medicine",
                tools: ["üíä Fever Medicine", "ü©π Bandage", "üíâ IV Drip", "üî¨ Lab Test"],
                instructor: "High fever requires antipyretic medication. Check temperature first!"
            },
            {
                problem: "Wound Infection",
                emoji: "ü©∏",
                description: "Deep cut on leg showing signs of infection. Red, swollen, and painful.",
                correctTool: "üíâ Antibiotics & Bandage",
                tools: ["üíâ Antibiotics & Bandage", "üå°Ô∏è Thermometer", "üíä Pain Killer", "ü©π Simple Bandage"],
                instructor: "This wound is infected! Clean it, apply antibiotics, and dress it properly."
            },
            {
                problem: "Heart Palpitations",
                emoji: "üíî",
                description: "Patient experiencing chest discomfort and irregular heartbeat.",
                correctTool: "üìü ECG Monitor",
                tools: ["üìü ECG Monitor", "üíä Aspirin", "üíâ Injection", "üå°Ô∏è Blood Pressure"],
                instructor: "Check heart rhythm immediately with ECG! This could be serious."
            },
            {
                problem: "Severe Headache",
                emoji: "üòµ",
                description: "Patient has intense migraine with sensitivity to light and nausea.",
                correctTool: "üíä Pain Relief",
                tools: ["üíä Pain Relief", "ü©π Bandage", "üíâ IV Fluids", "üî¨ Brain Scan"],
                instructor: "Migraine requires pain medication and a calm environment."
            },
            {
                problem: "Dehydration",
                emoji: "ü•µ",
                description: "Patient is dizzy, has dry mouth, and low blood pressure from heat exposure.",
                correctTool: "üíâ IV Fluids",
                tools: ["üíâ IV Fluids", "üíä Pills", "ü©π Bandage", "üå°Ô∏è Thermometer"],
                instructor: "Severe dehydration needs immediate IV fluid replacement!"
            }
        ];

        let hospitalPatients = [];

        // Road network
        const roads = [];
        for (let x = 5; x < WORLD_WIDTH; x += 10) {
            for (let y = 0; y < WORLD_HEIGHT; y++) {
                roads.push({ x, y, type: 'vertical' });
                roads.push({ x: x + 1, y, type: 'vertical' });
            }
        }
        for (let y = 5; y < WORLD_HEIGHT; y += 10) {
            for (let x = 0; x < WORLD_WIDTH; x++) {
                roads.push({ x, y: y, type: 'horizontal' });
                roads.push({ x, y: y + 1, type: 'horizontal' });
            }
        }

        // NPCs
        const npcs = [
            { x: 20, y: 10, emoji: 'üèÉ', type: 'jogger', name: 'Jogger', angry: false, dx: 0.05, dy: 0, patrolX: [15, 25] },
            { x: 30, y: 20, emoji: 'üö∂', type: 'walker', name: 'Pedestrian', angry: false, dx: 0, dy: 0.03, patrolY: [15, 25] },
            { x: 40, y: 30, emoji: 'üëÆ', type: 'cop', name: 'Officer', angry: false, dx: 0.04, dy: 0, patrolX: [35, 45] },
            { x: 15, y: 35, emoji: 'üßë', type: 'person', name: 'Citizen', angry: false, dx: -0.03, dy: 0, patrolX: [10, 20] },
            { x: 25, y: 45, emoji: 'üë®‚Äçüíº', type: 'businessman', name: 'Businessman', angry: false, dx: 0, dy: -0.04, patrolY: [40, 50] },
        ];

        // World objects
        const worldObjects = [
            { x: 38, y: 18, emoji: 'üè•', type: 'hospital', name: 'City Hospital', size: 4 },
            { x: 37, y: 22, emoji: 'üöë', type: 'ambulance', name: 'Ambulance' },
            { x: 8, y: 8, emoji: 'üè†', type: 'home', name: 'Your Home', size: 2 },
            { x: 25, y: 8, emoji: '‚õ™', type: 'church', name: 'Church', size: 3 },
            { x: 23, y: 7, emoji: 'üå≤', type: 'tree', size: 2.5 },
            { x: 28, y: 7, emoji: 'üå≤', type: 'tree', size: 2.5 },
            { x: 23, y: 11, emoji: 'üå≥', type: 'tree', size: 2.5 },
            { x: 28, y: 11, emoji: 'üå≥', type: 'tree', size: 2.5 },
            { x: 17, y: 18, emoji: 'üè™', type: 'supermarket', name: 'Supermarket', size: 3 },
            { x: 16, y: 17, emoji: 'üõí', type: 'cart', name: 'Shopping Cart' },
            { x: 48, y: 12, emoji: 'üèòÔ∏è', type: 'building', name: 'Apartments', size: 3 },
            { x: 12, y: 28, emoji: 'üè°', type: 'house', name: 'House', size: 2 },
            { x: 48, y: 35, emoji: 'üè¢', type: 'office', name: 'Office Building', size: 3 },
            { x: 8, y: 45, emoji: 'üè†', type: 'house', name: 'House', size: 2 },
            { x: 7, y: 11, emoji: 'üöó', type: 'car', name: 'Sedan', speed: 0.4 },
            { x: 24, y: 15, emoji: 'üöï', type: 'taxi', name: 'Taxi', speed: 0.45 },
            { x: 50, y: 22, emoji: 'üöô', type: 'suv', name: 'SUV', speed: 0.35 },
            { x: 18, y: 32, emoji: 'üèéÔ∏è', type: 'sports', name: 'Sports Car', speed: 0.6 },
            { x: 2, y: 2, emoji: 'üå≤', type: 'tree', size: 3 },
            { x: 4, y: 3, emoji: 'üå≤', type: 'tree', size: 2.8 },
            { x: 3, y: 5, emoji: 'üå≥', type: 'tree', size: 3.2 },
            { x: 52, y: 2, emoji: 'üå≥', type: 'tree', size: 3 },
            { x: 54, y: 4, emoji: 'üå≤', type: 'tree', size: 2.7 },
            { x: 48, y: 48, emoji: 'üå≥', type: 'tree', size: 3.5 },
            { x: 50, y: 49, emoji: 'üå≤', type: 'tree', size: 3.2 },
        ];

        function speak(text, pitch = 1, rate = 1) {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.pitch = pitch;
                utterance.rate = rate;
                utterance.volume = 1;
                speechSynthesis.speak(utterance);
            }
        }

        // Hunger system
        function updateHunger() {
            player.hunger -= 0.02;
            if (player.hunger < 0) player.hunger = 0;
            if (player.hunger > 100) player.hunger = 100;

            document.getElementById('hungerText').textContent = Math.floor(player.hunger) + '%';
            const fill = document.getElementById('hungerFill');
            fill.style.width = player.hunger + '%';

            fill.classList.remove('low', 'critical');
            if (player.hunger < 30) fill.classList.add('critical');
            else if (player.hunger < 50) fill.classList.add('low');

            if (player.hunger <= 0) {
                speak("You're starving! You need to eat something immediately!", 1.3, 1.2);
                player.speed = player.baseSpeed * 0.5;
            } else if (player.hunger < 20 && Math.random() < 0.01) {
                speak("I'm so hungry...", 1, 0.9);
            }
        }

        function eatFood(hungerRestore) {
            player.hunger += hungerRestore;
            if (player.hunger > 100) player.hunger = 100;
            player.speed = player.inVehicle ? (nearObject?.speed || 0.4) : player.baseSpeed;
            updateHunger();
        }

        // Church functions
        function enterChurch() {
            inChurch = true;
            document.getElementById('churchInterior').style.display = 'block';
            document.getElementById('gameCanvas').style.display = 'none';
            document.getElementById('minimap').style.display = 'none';
            document.getElementById('actionBtn').style.display = 'none';
            getNewVerse();
        }

        function getNewVerse() {
            const verse = bibleVerses[Math.floor(Math.random() * bibleVerses.length)];
            document.getElementById('bibleVerse').textContent = `"${verse.verse}"`;
            document.getElementById('verseReference').textContent = verse.ref;
            speak(verse.verse, 0.9, 0.85);
        }

        function exitChurch() {
            inChurch = false;
            document.getElementById('churchInterior').style.display = 'none';
            document.getElementById('gameCanvas').style.display = 'block';
            document.getElementById('minimap').style.display = 'block';
            speak("May God bless you on your journey.", 0.9, 0.85);
        }

        // Home functions
        function enterHome() {
            inHome = true;
            document.getElementById('homeInterior').style.display = 'block';
            document.getElementById('gameCanvas').style.display = 'none';
            document.getElementById('minimap').style.display = 'none';
            document.getElementById('actionBtn').style.display = 'none';
            speak("Welcome home, sweetheart!", 1.3, 1);
        }

        function talkToMom() {
            const phrases = [
                "How was work at the hospital today, honey?",
                "You look tired! Let me make you something to eat!",
                "I made your favorite dish today!",
                "Don't forget to eat properly, you're working so hard!",
                "Your father and I are so proud of you, doctor!"
            ];
            speak(phrases[Math.floor(Math.random() * phrases.length)], 1.4, 1);
        }

        function talkToDad() {
            const phrases = [
                "Hey doc, how's it going at the hospital?",
                "Saved any lives today, champ?",
                "You're doing great work out there!",
                "Come sit with me and relax for a bit!",
                "Your mom's cooking smells amazing, doesn't it?"
            ];
            speak(phrases[Math.floor(Math.random() * phrases.length)], 0.8, 0.9);
        }

        function getMomFood() {
            const foods = [
                { name: "Mom's Homemade Soup", restore: 50 },
                { name: "Delicious Pasta", restore: 60 },
                { name: "Special Fried Rice", restore: 55 },
                { name: "Chicken Adobo", restore: 65 }
            ];
            const food = foods[Math.floor(Math.random() * foods.length)];
            eatFood(food.restore);
            speak(`Here's some fresh ${food.name} for you! Eat up, you need your energy!`, 1.3, 1);
            document.getElementById('hungerText').textContent = Math.floor(player.hunger) + '%';
        }

        function exitHome() {
            inHome = false;
            document.getElementById('homeInterior').style.display = 'none';
            document.getElementById('gameCanvas').style.display = 'block';
            document.getElementById('minimap').style.display = 'block';
            speak("Take care, see you later!", 1.2, 1);
        }

        // Hospital functions
        function generatePatients() {
            hospitalPatients = [];
            const numPatients = 6;
            for (let i = 0; i < numPatients; i++) {
                const caseData = medicalCases[Math.floor(Math.random() * medicalCases.length)];
                hospitalPatients.push({
                    id: i,
                    ...caseData,
                    treated: false
                });
            }
        }

        function enterHospital() {
            inHospital = true;
            document.getElementById('hospitalInterior').style.display = 'block';
            document.getElementById('gameCanvas').style.display = 'none';
            document.getElementById('minimap').style.display = 'none';
            document.getElementById('actionBtn').style.display = 'none';
            generatePatients();
            renderHospitalPatients();
            speak("Welcome to your shift, Doctor! You have patients waiting for treatment.", 1, 1);
        }

        function renderHospitalPatients() {
            const patientList = document.getElementById('patientList');
            patientList.innerHTML = '';
            
            hospitalPatients.forEach(patient => {
                const bed = document.createElement('div');
                bed.className = 'patient-bed' + (patient.treated ? ' treated' : '');
                bed.innerHTML = `
                    <div style="font-size: 48px;">${patient.emoji}</div>
                    <h3>${patient.problem}</h3>
                    <p>${patient.treated ? '‚úÖ Treated' : '‚è≥ Waiting'}</p>
                `;
                if (!patient.treated) {
                    bed.onclick = () => diagnosePatient(patient);
                }
                patientList.appendChild(bed);
            });
        }

        function diagnosePatient(patient) {
            currentPatient = patient;
            document.getElementById('patientProblem').textContent = `ü©∫ ${patient.problem}`;
            document.getElementById('patientDescription').textContent = patient.description;
            speak(patient.instructor, 1, 0.95);
            
            const toolOptions = document.getElementById('toolOptions');
            toolOptions.innerHTML = '';
            
            patient.tools.forEach(tool => {
                const option = document.createElement('div');
                option.className = 'tool-option';
                option.textContent = tool;
                option.onclick = () => selectTool(tool, patient);
                toolOptions.appendChild(option);
            });
            
            document.getElementById('treatmentPanel').style.display = 'block';
        }

        function selectTool(tool, patient) {
            const options = document.querySelectorAll('.tool-option');
            options.forEach(opt => {
                opt.style.pointerEvents = 'none';
                if (opt.textContent === tool) {
                    if (tool === patient.correctTool) {
                        opt.classList.add('correct');
                        speak("Excellent diagnosis, Doctor! Patient successfully treated!", 1.2, 1);
                        player.money += 50;
                        player.patientsTreated++;
                        document.getElementById('money').textContent = `Money: ${player.money}`;
                        document.getElementById('patientCount').textContent = player.patientsTreated;
                        patient.treated = true;
                        setTimeout(() => {
                            closeTreatment();
                            renderHospitalPatients();
                            if (hospitalPatients.every(p => p.treated)) {
                                speak("Congratulations! All patients treated successfully!", 1.1, 1);
                            }
                        }, 2000);
                    } else {
                        opt.classList.add('wrong');
                        speak("That's not the correct treatment. Try again!", 1, 0.9);
                        setTimeout(() => {
                            closeTreatment();
                        }, 3000);
                    }
                }
            });
        }

        function closeTreatment() {
            document.getElementById('treatmentPanel').style.display = 'none';
            currentPatient = null;
        }

        function exitHospital() {
            inHospital = false;
            document.getElementById('hospitalInterior').style.display = 'none';
            document.getElementById('gameCanvas').style.display = 'block';
            document.getElementById('minimap').style.display = 'block';
            speak("Good work today, Doctor!", 1, 1);
        }

        // Update NPCs
        function updateNPCs() {
            npcs.forEach(npc => {
                if (npc.patrolX) {
                    npc.x += npc.dx;
                    if (npc.x <= npc.patrolX[0] || npc.x >= npc.patrolX[1]) {
                        npc.dx *= -1;
                    }
                }
                if (npc.patrolY) {
                    npc.y += npc.dy;
                    if (npc.y <= npc.patrolY[0] || npc.y >= npc.patrolY[1]) {
                        npc.dy *= -1;
                    }
                }

                const dx = Math.abs(player.x - npc.x);
                const dy = Math.abs(player.y - npc.y);
                if (dx < 1 && dy < 1 && !npc.angry) {
                    npc.angry = true;
                    const originalEmoji = npc.emoji;
                    npc.emoji = 'üò†';
                    const phrases = ["Watch your step, kid!", "Hey! Watch where you're going!", "Move it!"];
                    speak(phrases[Math.floor(Math.random() * phrases.length)], 1.2, 1.1);
                    setTimeout(() => {
                        npc.angry = false;
                        npc.emoji = originalEmoji;
                    }, 3000);
                }
            });
        }

        function drawWorld() {
            ctx.fillStyle = '#2d5016';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = '#3d6020';
            for (let i = 0; i < 200; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                ctx.fillRect(x, y, 2, 2);
            }

            roads.forEach(road => {
                const screenX = (road.x - camera.x) * TILE_SIZE;
                const screenY = (road.y - camera.y) * TILE_SIZE;
                if (screenX > -TILE_SIZE && screenX < canvas.width && screenY > -TILE_SIZE && screenY < canvas.height) {
                    ctx.fillStyle = '#3a3a3a';
                    ctx.fillRect(screenX, screenY, TILE_SIZE, TILE_SIZE);
                    if (road.type === 'horizontal' && road.x % 2 === 0) {
                        ctx.fillStyle = '#ffff00';
                        ctx.fillRect(screenX + TILE_SIZE/2 - 2, screenY + TILE_SIZE/2 - 1, 10, 2);
                    }
                    if (road.type === 'vertical' && road.y % 2 === 0) {
                        ctx.fillStyle = '#ffff00';
                        ctx.fillRect(screenX + TILE_SIZE/2 - 1, screenY + TILE_SIZE/2 - 2, 2, 10);
                    }
                }
            });

            worldObjects.forEach(obj => {
                if (obj.hidden) return;
                const size = obj.size || 1;
                const screenX = (obj.x - camera.x) * TILE_SIZE;
                const screenY = (obj.y - camera.y) * TILE_SIZE;
                if (screenX > -TILE_SIZE*size && screenX < canvas.width && screenY > -TILE_SIZE*size && screenY < canvas.height) {
                    ctx.font = `${TILE_SIZE * size * 0.9}px Arial`;
                    ctx.fillText(obj.emoji, screenX, screenY + TILE_SIZE * size * 0.85);
                }
            });

            npcs.forEach(npc => {
                const screenX = (npc.x - camera.x) * TILE_SIZE;
                const screenY = (npc.y - camera.y) * TILE_SIZE;
                if (screenX > -TILE_SIZE && screenX < canvas.width && screenY > -TILE_SIZE && screenY < canvas.height) {
                    ctx.font = `${TILE_SIZE * 0.9}px Arial`;
                    ctx.fillText(npc.emoji, screenX, screenY + TILE_SIZE * 0.85);
                }
            });

            const screenX = (player.x - camera.x) * TILE_SIZE;
            const screenY = (player.y - camera.y) * TILE_SIZE;
            ctx.font = `${TILE_SIZE * 0.9}px Arial`;
            ctx.fillText(player.emoji, screenX, screenY + TILE_SIZE * 0.85);

            drawMinimap();
        }

        function drawMinimap() {
            const scale = 2.5;
            minimapCtx.fillStyle = 'rgba(0, 50, 0, 0.8)';
            minimapCtx.fillRect(0, 0, 150, 150);

            minimapCtx.fillStyle = '#666';
            roads.forEach(road => {
                minimapCtx.fillRect(road.x * scale, road.y * scale, scale, scale);
            });

            minimapCtx.fillStyle = '#888';
            worldObjects.forEach(obj => {
                if (obj.type === 'house' || obj.type === 'home' || obj.type === 'building' || obj.type === 'church' || obj.type === 'supermarket') {
                    minimapCtx.fillRect(obj.x * scale, obj.y * scale, scale * 2, scale * 2);
                }
                if (obj.type === 'hospital') {
                    minimapCtx.fillStyle = '#ff0000';
                    minimapCtx.fillRect(obj.x * scale, obj.y * scale, scale * 3, scale * 3);
                    minimapCtx.fillStyle = '#888';
                }
            });

            minimapCtx.fillStyle = '#00ff00';
            minimapCtx.fillRect(player.x * scale - 1, player.y * scale - 1, scale + 2, scale + 2);
        }

        function updateCamera() {
            camera.x = player.x - canvas.width / TILE_SIZE / 2;
            camera.y = player.y - canvas.height / TILE_SIZE / 2;
            camera.x = Math.max(0, Math.min(camera.x, WORLD_WIDTH - canvas.width / TILE_SIZE));
            camera.y = Math.max(0, Math.min(camera.y, WORLD_HEIGHT - canvas.height / TILE_SIZE));
        }

        function checkNearbyObjects() {
            nearObject = null;
            const checkDistance = 3;

            for (let npc of npcs) {
                const dx = Math.abs(player.x - npc.x);
                const dy = Math.abs(player.y - npc.y);
                const distance = Math.sqrt(dx * dx + dy * dy);
                if (distance < checkDistance) {
                    nearObject = npc;
                    document.getElementById('actionBtn').style.display = 'block';
                    document.getElementById('actionBtn').textContent = `Press E - Talk to ${npc.name}`;
                    return;
                }
            }

            for (let obj of worldObjects) {
                if (obj.hidden) continue;
                const dx = Math.abs(player.x - obj.x);
                const dy = Math.abs(player.y - obj.y);
                const distance = Math.sqrt(dx * dx + dy * dy);
                if (distance < checkDistance) {
                    nearObject = obj;
                    document.getElementById('actionBtn').style.display = 'block';
                    if (obj.type === 'hospital') {
                        document.getElementById('actionBtn').textContent = `Press E - Enter Hospital`;
                    } else if (obj.type === 'church') {
                        document.getElementById('actionBtn').textContent = `Press E - Enter Church`;
                    } else if (obj.type === 'home') {
                        document.getElementById('actionBtn').textContent = `Press E - Enter Home`;
                    } else {
                        document.getElementById('actionBtn').textContent = `Press E - ${obj.name || obj.type}`;
                    }
                    return;
                }
            }

            document.getElementById('actionBtn').style.display = 'none';
        }

        function interact() {
            if (!nearObject) return;

            if (npcs.includes(nearObject)) {
                const npc = nearObject;
                if (!npc.angry) {
                    npc.angry = true;
                    const originalEmoji = npc.emoji;
                    npc.emoji = 'üò†';
                    speak("Watch your step, kid!", 1.2, 1.1);
                    setTimeout(() => {
                        npc.angry = false;
                        npc.emoji = originalEmoji;
                    }, 3000);
                }
                return;
            }

            switch(nearObject.type) {
                case 'hospital':
                    enterHospital();
                    break;
                case 'church':
                    enterChurch();
                    break;
                case 'home':
                    enterHome();
                    break;
                case 'supermarket':
                    document.getElementById('shop').style.display = 'block';
                    speak("Welcome to the supermarket! Buy food to restore your hunger!", 1.2, 1);
                    break;
                case 'car':
                case 'taxi':
                case 'suv':
                case 'sports':
                    if (!player.inVehicle) {
                        player.inVehicle = true;
                        player.emoji = nearObject.emoji;
                        player.speed = nearObject.speed || 0.4;
                        nearObject.hidden = true;
                        document.getElementById('speed').textContent = 'Driving!';
                        document.getElementById('playerIcon').textContent = nearObject.emoji;
                        speak("You're now driving!", 1, 1.2);
                    } else {
                        player.inVehicle = false;
                        player.emoji = 'üë®‚Äç‚öïÔ∏è';
                        player.speed = player.baseSpeed;
                        nearObject.hidden = false;
                        nearObject.x = player.x;
                        nearObject.y = player.y;
                        document.getElementById('speed').textContent = 'Walking';
                        document.getElementById('playerIcon').textContent = 'üë®‚Äç‚öïÔ∏è';
                        speak("You exited the vehicle.", 1, 1);
                    }
                    break;
            }
        }

        function buyFood(foodName, price, hungerRestore) {
            if (player.money >= price) {
                player.money -= price;
                eatFood(hungerRestore);
                document.getElementById('money').textContent = `Money: ${player.money}`;
                speak(`You bought ${foodName}! Hunger restored!`, 1.2, 1.1);
            } else {
                speak("You don't have enough money!", 1.3, 1.2);
            }
        }

        function closeShop() {
            document.getElementById('shop').style.display = 'none';
        }

        function updatePlayer() {
            const prevX = player.x;
            const prevY = player.y;

            let speedMultiplier = 1;
            if (keys['Shift']) speedMultiplier = 2;

            if (keys['w'] || keys['ArrowUp']) player.y -= player.speed * speedMultiplier;
            if (keys['s'] || keys['ArrowDown']) player.y += player.speed * speedMultiplier;
            if (keys['a'] || keys['ArrowLeft']) player.x -= player.speed * speedMultiplier;
            if (keys['d'] || keys['ArrowRight']) player.x += player.speed * speedMultiplier;

            if (speedMultiplier > 1) {
                document.getElementById('speed').textContent = player.inVehicle ? 'Fast Driving!' : 'Running!';
            } else {
                document.getElementById('speed').textContent = player.inVehicle ? 'Driving' : 'Walking';
            }

            player.x = Math.max(0, Math.min(player.x, WORLD_WIDTH - 1));
            player.y = Math.max(0, Math.min(player.y, WORLD_HEIGHT - 1));

            for (let obj of worldObjects) {
                if (obj.hidden) continue;
                if (obj.type === 'tree' || obj.type === 'building' || obj.type === 'house' || obj.type === 'home' || obj.type === 'church' || obj.type === 'office') {
                    const objSize = obj.size || 1;
                    const dx = Math.abs(player.x - obj.x);
                    const dy = Math.abs(player.y - obj.y);
                    if (dx < objSize * 0.9 && dy < objSize * 0.9) {
                        player.x = prevX;
                        player.y = prevY;
                    }
                }
            }

            checkNearbyObjects();
        }

        function gameLoop() {
            if (!inHospital && !inChurch && !inHome) {
                updatePlayer();
                updateNPCs();
                updateCamera();
                drawWorld();
                updateHunger();
            }
            requestAnimationFrame(gameLoop);
        }

        window.addEventListener('keydown', (e) => {
            keys[e.key] = true;
            if (e.key === 'e' || e.key === 'E') {
                interact();
            }
        });

        window.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        document.getElementById('actionBtn').addEventListener('click', interact);

        document.querySelectorAll('.control-btn').forEach(btn => {
            btn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const dir = btn.dataset.dir;
                if (dir === 'up') keys['w'] = true;
                if (dir === 'down') keys['s'] = true;
                if (dir === 'left') keys['a'] = true;
                if (dir === 'right') keys['d'] = true;
            });

            btn.addEventListener('touchend', (e) => {
                e.preventDefault();
                const dir = btn.dataset.dir;
                if (dir === 'up') keys['w'] = false;
                if (dir === 'down') keys['s'] = false;
                if (dir === 'left') keys['a'] = false;
                if (dir === 'right') keys['d'] = false;
            });
        });

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

        window.buyFood = buyFood;
        window.closeShop = closeShop;
        window.exitHospital = exitHospital;
        window.closeTreatment = closeTreatment;
        window.exitChurch = exitChurch;
        window.getNewVerse = getNewVerse;
        window.exitHome = exitHome;
        window.talkToMom = talkToMom;
        window.talkToDad = talkToDad;
        window.getMomFood = getMomFood;

        gameLoop();
        
        setTimeout(() => {
            speak("Good morning, Doctor! Don't forget to eat when you're hungry. Head to the hospital to start your shift!", 1, 1);
        }, 500);
    </script>
</body>
</html>
