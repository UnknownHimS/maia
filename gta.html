<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTA Emoji World - Doctor Life</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            background: #1a1a1a;
        }

        #gameCanvas {
            display: block;
            background: #2d5016;
            image-rendering: crisp-edges;
        }

        #ui {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 100;
            border: 2px solid #4CAF50;
        }

        #money {
            color: #4CAF50;
            font-weight: bold;
            font-size: 18px;
        }

        #minimap {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 150px;
            height: 150px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #4CAF50;
            border-radius: 10px;
            z-index: 100;
        }

        #controls {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 10px;
            font-size: 12px;
            border: 2px solid #4CAF50;
        }

        #actionBtn {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 10px;
            cursor: pointer;
            display: none;
            z-index: 100;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        #actionBtn:hover {
            background: #45a049;
        }

        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            display: none;
            z-index: 200;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .shop-item, .patient-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #ddd;
            margin-bottom: 10px;
        }

        .shop-item button, .patient-item button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        .shop-item button:hover, .patient-item button:hover {
            background: #45a049;
        }

        .close-btn {
            margin-top: 15px;
            width: 100%;
            padding: 10px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #hospitalInterior {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #e8f5e9;
            display: none;
            z-index: 150;
        }

        #hospitalUI {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #4CAF50;
        }

        #hospitalUI h2 {
            color: #2196F3;
            margin-bottom: 10px;
        }

        #exitHospital {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #f44336;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 10px;
            cursor: pointer;
        }

        #patientList {
            position: absolute;
            top: 120px;
            left: 20px;
            right: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .patient-bed {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 3px solid #2196F3;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .patient-bed:hover {
            transform: scale(1.05);
            border-color: #4CAF50;
        }

        .patient-bed.treated {
            border-color: #4CAF50;
            background: #c8e6c9;
        }

        .patient-emoji {
            font-size: 48px;
        }

        #treatmentPanel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            display: none;
            z-index: 250;
            box-shadow: 0 0 30px rgba(0,0,0,0.7);
            max-width: 600px;
        }

        #treatmentPanel h2 {
            color: #2196F3;
            margin-bottom: 20px;
        }

        .tool-option {
            padding: 15px;
            margin: 10px 0;
            background: #f5f5f5;
            border-radius: 10px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .tool-option:hover {
            background: #e3f2fd;
            border-color: #2196F3;
        }

        .tool-option.correct {
            background: #c8e6c9;
            border-color: #4CAF50;
        }

        .tool-option.wrong {
            background: #ffcdd2;
            border-color: #f44336;
        }

        #mobileControls {
            position: fixed;
            bottom: 80px;
            right: 10px;
            display: none;
            z-index: 100;
        }

        .control-pad {
            display: grid;
            grid-template-columns: repeat(3, 60px);
            grid-template-rows: repeat(3, 60px);
            gap: 5px;
        }

        .control-btn {
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: 2px solid #4CAF50;
            border-radius: 10px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:active {
            background: rgba(0, 0, 0, 0.8);
        }

        @media (max-width: 768px) {
            #mobileControls {
                display: block;
            }
            #controls {
                display: none;
            }
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <canvas id="minimap"></canvas>
    
    <div id="ui">
        <div>Dr. <span id="playerIcon">üë®‚Äç‚öïÔ∏è</span></div>
        <div id="money">Money: $100</div>
        <div>Patients Treated: <span id="patientCount">0</span></div>
        <div>Speed: <span id="speed">Walking</span></div>
        <div>Inventory: <span id="inventory">Empty</span></div>
    </div>

    <div id="controls">
        <div>üéÆ WASD or Arrow Keys to move</div>
        <div>E - Interact when near objects</div>
        <div>SHIFT - Run faster</div>
    </div>

    <button id="actionBtn">Press E</button>

    <div id="shop" class="modal">
        <h2>üè™ Supermarket</h2>
        <div class="shop-item">
            <span>üçï Pizza - $10</span>
            <button onclick="buyItem('üçï', 10)">Buy</button>
        </div>
        <div class="shop-item">
            <span>üçî Burger - $8</span>
            <button onclick="buyItem('üçî', 8)">Buy</button>
        </div>
        <div class="shop-item">
            <span>ü•§ Soda - $3</span>
            <button onclick="buyItem('ü•§', 3)">Buy</button>
        </div>
        <div class="shop-item">
            <span>üçé Apple - $2</span>
            <button onclick="buyItem('üçé', 2)">Buy</button>
        </div>
        <button class="close-btn" onclick="closeShop()">Close</button>
    </div>

    <div id="hospitalInterior">
        <div id="hospitalUI">
            <h2>üè• City Hospital - Doctor's Shift</h2>
            <p>Click on patients to diagnose and treat them!</p>
            <p>Earn $50 for each patient treated correctly.</p>
        </div>
        <button id="exitHospital" onclick="exitHospital()">Exit Hospital</button>
        <div id="patientList"></div>
    </div>

    <div id="treatmentPanel">
        <h2 id="patientProblem">Patient Problem</h2>
        <p id="patientDescription"></p>
        <h3>Select the correct medical tool:</h3>
        <div id="toolOptions"></div>
        <button class="close-btn" onclick="closeTreatment()">Cancel</button>
    </div>

    <div id="mobileControls">
        <div class="control-pad">
            <div></div>
            <button class="control-btn" data-dir="up">‚Üë</button>
            <div></div>
            <button class="control-btn" data-dir="left">‚Üê</button>
            <div></div>
            <button class="control-btn" data-dir="right">‚Üí</button>
            <div></div>
            <button class="control-btn" data-dir="down">‚Üì</button>
            <div></div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const minimapCanvas = document.getElementById('minimap');
        const minimapCtx = minimapCanvas.getContext('2d');
        
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const TILE_SIZE = 50;
        const WORLD_WIDTH = 60;
        const WORLD_HEIGHT = 60;

        // Camera
        let camera = {
            x: 0,
            y: 0
        };

        // Game state
        let player = {
            x: 10,
            y: 10,
            emoji: 'üë®‚Äç‚öïÔ∏è',
            speed: 0.15,
            baseSpeed: 0.15,
            inVehicle: false,
            money: 100,
            inventory: [],
            patientsTreated: 0,
            isDoctor: true
        };

        let keys = {};
        let nearObject = null;
        let currentPatient = null;
        let inHospital = false;

        // Medical cases database
        const medicalCases = [
            {
                problem: "Broken Arm",
                emoji: "ü§ï",
                description: "Patient fell and has severe pain in left arm. Visible deformity and swelling.",
                correctTool: "ü©π Cast & X-Ray",
                tools: ["ü©π Cast & X-Ray", "üíä Medicine", "üíâ Injection", "üå°Ô∏è Thermometer"],
                instructor: "This patient has a fracture. You need to take an X-ray and apply a cast!"
            },
            {
                problem: "High Fever",
                emoji: "ü§í",
                description: "Patient has temperature of 103¬∞F, complaining of body aches and chills.",
                correctTool: "üíä Fever Medicine",
                tools: ["üíä Fever Medicine", "ü©π Bandage", "üíâ IV Drip", "üî¨ Lab Test"],
                instructor: "High fever requires antipyretic medication. Check temperature first!"
            },
            {
                problem: "Wound Infection",
                emoji: "ü©∏",
                description: "Deep cut on leg showing signs of infection. Red, swollen, and painful.",
                correctTool: "üíâ Antibiotics & Bandage",
                tools: ["üíâ Antibiotics & Bandage", "üå°Ô∏è Thermometer", "üíä Pain Killer", "ü©π Simple Bandage"],
                instructor: "This wound is infected! Clean it, apply antibiotics, and dress it properly."
            },
            {
                problem: "Heart Palpitations",
                emoji: "üíî",
                description: "Patient experiencing chest discomfort and irregular heartbeat.",
                correctTool: "üìü ECG Monitor",
                tools: ["üìü ECG Monitor", "üíä Aspirin", "üíâ Injection", "üå°Ô∏è Blood Pressure"],
                instructor: "Check heart rhythm immediately with ECG! This could be serious."
            },
            {
                problem: "Severe Headache",
                emoji: "üòµ",
                description: "Patient has intense migraine with sensitivity to light and nausea.",
                correctTool: "üíä Pain Relief",
                tools: ["üíä Pain Relief", "ü©π Bandage", "üíâ IV Fluids", "üî¨ Brain Scan"],
                instructor: "Migraine requires pain medication and a calm environment."
            },
            {
                problem: "Dehydration",
                emoji: "ü•µ",
                description: "Patient is dizzy, has dry mouth, and low blood pressure from heat exposure.",
                correctTool: "üíâ IV Fluids",
                tools: ["üíâ IV Fluids", "üíä Pills", "ü©π Bandage", "üå°Ô∏è Thermometer"],
                instructor: "Severe dehydration needs immediate IV fluid replacement!"
            },
            {
                problem: "Allergic Reaction",
                emoji: "üò∑",
                description: "Patient has swelling, rash, and difficulty breathing after bee sting.",
                correctTool: "üíâ EpiPen",
                tools: ["üíâ EpiPen", "üíä Antihistamine", "ü©π Ice Pack", "üå°Ô∏è Oxygen"],
                instructor: "Anaphylaxis! Administer epinephrine immediately!"
            },
            {
                problem: "Stomach Pain",
                emoji: "ü§¢",
                description: "Severe abdominal pain in lower right quadrant. Possible appendicitis.",
                correctTool: "üî¨ Ultrasound Scan",
                tools: ["üî¨ Ultrasound Scan", "üíä Antacid", "üíâ Pain Relief", "üå°Ô∏è Blood Test"],
                instructor: "Could be appendicitis. Need imaging to confirm before surgery!"
            }
        ];

        let hospitalPatients = [];

        // Road network
        const roads = [];
        for (let x = 5; x < WORLD_WIDTH; x += 10) {
            for (let y = 0; y < WORLD_HEIGHT; y++) {
                roads.push({ x, y, type: 'vertical' });
                roads.push({ x: x + 1, y, type: 'vertical' });
            }
        }
        for (let y = 5; y < WORLD_HEIGHT; y += 10) {
            for (let x = 0; x < WORLD_WIDTH; x++) {
                roads.push({ x, y: y, type: 'horizontal' });
                roads.push({ x, y: y + 1, type: 'horizontal' });
            }
        }

        // NPCs with AI movement
        const npcs = [
            { x: 20, y: 10, emoji: 'üèÉ', type: 'jogger', name: 'Jogger', angry: false, dx: 0.05, dy: 0, patrolX: [15, 25] },
            { x: 30, y: 20, emoji: 'üö∂', type: 'walker', name: 'Pedestrian', angry: false, dx: 0, dy: 0.03, patrolY: [15, 25] },
            { x: 40, y: 30, emoji: 'üëÆ', type: 'cop', name: 'Officer', angry: false, dx: 0.04, dy: 0, patrolX: [35, 45] },
            { x: 15, y: 35, emoji: 'üßë', type: 'person', name: 'Citizen', angry: false, dx: -0.03, dy: 0, patrolX: [10, 20] },
            { x: 25, y: 45, emoji: 'üë®‚Äçüíº', type: 'businessman', name: 'Businessman', angry: false, dx: 0, dy: -0.04, patrolY: [40, 50] },
        ];

        // World objects
        const worldObjects = [
            // HOSPITAL - Main feature!
            { x: 38, y: 18, emoji: 'üè•', type: 'hospital', name: 'City Hospital', size: 4 },
            { x: 37, y: 22, emoji: 'üöë', type: 'ambulance', name: 'Ambulance' },
            
            // Player's house area
            { x: 8, y: 8, emoji: 'üè†', type: 'house', name: 'Your House', size: 2 },
            { x: 9, y: 9, emoji: 'üë®', type: 'dad', name: 'Dad', dx: 0.01, dy: 0, moving: true, range: [8.5, 10] },
            { x: 8.5, y: 9, emoji: 'üë©‚Äçüç≥', type: 'mom', name: 'Mom', dx: 0, dy: 0.01, moving: true, range: [8, 9.5] },
            
            // Churches with large trees
            { x: 25, y: 8, emoji: '‚õ™', type: 'church', name: 'Church', size: 3 },
            { x: 23, y: 7, emoji: 'üå≤', type: 'tree', size: 2.5 },
            { x: 28, y: 7, emoji: 'üå≤', type: 'tree', size: 2.5 },
            { x: 23, y: 11, emoji: 'üå≥', type: 'tree', size: 2.5 },
            { x: 28, y: 11, emoji: 'üå≥', type: 'tree', size: 2.5 },
            
            // Supermarket area
            { x: 17, y: 18, emoji: 'üè™', type: 'supermarket', name: 'Supermarket', size: 3 },
            { x: 16, y: 17, emoji: 'üõí', type: 'cart', name: 'Shopping Cart' },
            
            // Residential area
            { x: 48, y: 12, emoji: 'üèòÔ∏è', type: 'building', name: 'Apartments', size: 3 },
            { x: 12, y: 28, emoji: 'üè°', type: 'house', name: 'House', size: 2 },
            { x: 48, y: 35, emoji: 'üè¢', type: 'office', name: 'Office Building', size: 3 },
            { x: 8, y: 45, emoji: 'üè†', type: 'house', name: 'House', size: 2 },
            { x: 28, y: 38, emoji: 'üè°', type: 'house', name: 'House', size: 2 },
            
            // Vehicles
            { x: 7, y: 11, emoji: 'üöó', type: 'car', name: 'Sedan', speed: 0.4 },
            { x: 24, y: 15, emoji: 'üöï', type: 'taxi', name: 'Taxi', speed: 0.45 },
            { x: 50, y: 22, emoji: 'üöô', type: 'suv', name: 'SUV', speed: 0.35 },
            { x: 18, y: 32, emoji: 'üèéÔ∏è', type: 'sports', name: 'Sports Car', speed: 0.6 },
            
            // Forest areas with big trees
            { x: 2, y: 2, emoji: 'üå≤', type: 'tree', size: 3 },
            { x: 4, y: 3, emoji: 'üå≤', type: 'tree', size: 2.8 },
            { x: 3, y: 5, emoji: 'üå≥', type: 'tree', size: 3.2 },
            { x: 1, y: 7, emoji: 'üå≤', type: 'tree', size: 2.5 },
            { x: 52, y: 2, emoji: 'üå≥', type: 'tree', size: 3 },
            { x: 54, y: 4, emoji: 'üå≤', type: 'tree', size: 2.7 },
            { x: 53, y: 6, emoji: 'üå≥', type: 'tree', size: 3.1 },
            { x: 55, y: 8, emoji: 'üå≤', type: 'tree', size: 2.9 },
            { x: 2, y: 52, emoji: 'üå≤', type: 'tree', size: 3 },
            { x: 4, y: 53, emoji: 'üå≥', type: 'tree', size: 2.8 },
            { x: 3, y: 55, emoji: 'üå≤', type: 'tree', size: 3.2 },
            { x: 48, y: 48, emoji: 'üå≥', type: 'tree', size: 3.5 },
            { x: 50, y: 49, emoji: 'üå≤', type: 'tree', size: 3.2 },
            { x: 52, y: 48, emoji: 'üå≥', type: 'tree', size: 3.4 },
        ];

        // Speech synthesis
        function speak(text, pitch = 1, rate = 1) {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.pitch = pitch;
                utterance.rate = rate;
                utterance.volume = 1;
                speechSynthesis.speak(utterance);
            }
        }

        // Generate hospital patients
        function generatePatients() {
            hospitalPatients = [];
            const numPatients = 6;
            for (let i = 0; i < numPatients; i++) {
                const caseData = medicalCases[Math.floor(Math.random() * medicalCases.length)];
                hospitalPatients.push({
                    id: i,
                    ...caseData,
                    treated: false
                });
            }
        }

        // Enter hospital
        function enterHospital() {
            inHospital = true;
            document.getElementById('hospitalInterior').style.display = 'block';
            document.getElementById('gameCanvas').style.display = 'none';
            document.getElementById('minimap').style.display = 'none';
            document.getElementById('actionBtn').style.display = 'none';
            
            generatePatients();
            renderHospitalPatients();
            speak("Welcome to your shift, Doctor! You have patients waiting for treatment.", 1, 1);
        }

        // Render hospital patients
        function renderHospitalPatients() {
            const patientList = document.getElementById('patientList');
            patientList.innerHTML = '';
            
            hospitalPatients.forEach(patient => {
                const bed = document.createElement('div');
                bed.className = 'patient-bed' + (patient.treated ? ' treated' : '');
                bed.innerHTML = `
                    <div class="patient-emoji">${patient.emoji}</div>
                    <h3>${patient.problem}</h3>
                    <p>${patient.treated ? '‚úÖ Treated' : '‚è≥ Waiting'}</p>
                `;
                if (!patient.treated) {
                    bed.onclick = () => diagnosePatient(patient);
                }
                patientList.appendChild(bed);
            });
        }

        // Diagnose patient
        function diagnosePatient(patient) {
            currentPatient = patient;
            document.getElementById('patientProblem').textContent = `ü©∫ ${patient.problem}`;
            document.getElementById('patientDescription').textContent = patient.description;
            
            speak(patient.instructor, 1, 0.95);
            
            const toolOptions = document.getElementById('toolOptions');
            toolOptions.innerHTML = '';
            
            patient.tools.forEach(tool => {
                const option = document.createElement('div');
                option.className = 'tool-option';
                option.textContent = tool;
                option.onclick = () => selectTool(tool, patient);
                toolOptions.appendChild(option);
            });
            
            document.getElementById('treatmentPanel').style.display = 'block';
        }

        // Select treatment tool
        function selectTool(tool, patient) {
            const options = document.querySelectorAll('.tool-option');
            options.forEach(opt => {
                opt.style.pointerEvents = 'none';
                if (opt.textContent === tool) {
                    if (tool === patient.correctTool) {
                        opt.classList.add('correct');
                        speak("Excellent diagnosis, Doctor! Patient successfully treated!", 1.2, 1);
                        player.money += 50;
                        player.patientsTreated++;
                        document.getElementById('money').textContent = `Money: $${player.money}`;
                        document.getElementById('patientCount').textContent = player.patientsTreated;
                        patient.treated = true;
                        
                        setTimeout(() => {
                            closeTreatment();
                            renderHospitalPatients();
                            
                            if (hospitalPatients.every(p => p.treated)) {
                                speak("Congratulations! All patients treated successfully! You can take a break now.", 1.1, 1);
                            }
                        }, 2000);
                    } else {
                        opt.classList.add('wrong');
                        speak("That's not the correct treatment. The patient needs: " + patient.correctTool, 1, 0.9);
                        setTimeout(() => {
                            closeTreatment();
                        }, 3000);
                    }
                }
            });
        }

        // Close treatment panel
        function closeTreatment() {
            document.getElementById('treatmentPanel').style.display = 'none';
            currentPatient = null;
        }

        // Exit hospital
        function exitHospital() {
            inHospital = false;
            document.getElementById('hospitalInterior').style.display = 'none';
            document.getElementById('gameCanvas').style.display = 'block';
            document.getElementById('minimap').style.display = 'block';
            speak("Good work today, Doctor! Take care on your way home.", 1, 1);
        }

        // Update NPCs
        function updateNPCs() {
            npcs.forEach(npc => {
                if (npc.patrolX) {
                    npc.x += npc.dx;
                    if (npc.x <= npc.patrolX[0] || npc.x >= npc.patrolX[1]) {
                        npc.dx *= -1;
                    }
                }
                if (npc.patrolY) {
                    npc.y += npc.dy;
                    if (npc.y <= npc.patrolY[0] || npc.y >= npc.patrolY[1]) {
                        npc.dy *= -1;
                    }
                }

                const dx = Math.abs(player.x - npc.x);
                const dy = Math.abs(player.y - npc.y);
                if (dx < 1 && dy < 1 && !npc.angry) {
                    npc.angry = true;
                    const originalEmoji = npc.emoji;
                    npc.emoji = 'üò†';
                    const phrases = [
                        "Watch your step, kid!",
                        "Hey! Watch where you're going!",
                        "Move it, buddy!"
                    ];
                    speak(phrases[Math.floor(Math.random() * phrases.length)], 1.2, 1.1);
                    setTimeout(() => {
                        npc.angry = false;
                        npc.emoji = originalEmoji;
                    }, 3000);
                }
            });

            worldObjects.forEach(obj => {
                if (obj.moving && obj.dx !== undefined) {
                    obj.x += obj.dx;
                    if (obj.range && (obj.x <= obj.range[0] || obj.x >= obj.range[1])) {
                        obj.dx *= -1;
                    }
                }
                if (obj.moving && obj.dy !== undefined) {
                    obj.y += obj.dy;
                    if (obj.range && (obj.y <= obj.range[0] || obj.y >= obj.range[1])) {
                        obj.dy *= -1;
                    }
                }
            });
        }

        // Draw world
        function drawWorld() {
            ctx.fillStyle = '#2d5016';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw grass texture
            ctx.fillStyle = '#3d6020';
            for (let i = 0; i < 200; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                ctx.fillRect(x, y, 2, 2);
            }

            // Draw roads
            roads.forEach(road => {
                const screenX = (road.x - camera.x) * TILE_SIZE;
                const screenY = (road.y - camera.y) * TILE_SIZE;
                
                if (screenX > -TILE_SIZE && screenX < canvas.width && screenY > -TILE_SIZE && screenY < canvas.height) {
                    ctx.fillStyle = '#3a3a3a';
                    ctx.fillRect(screenX, screenY, TILE_SIZE, TILE_SIZE);
                    
                    if (road.type === 'horizontal' && road.x % 2 === 0) {
                        ctx.fillStyle = '#ffff00';
                        ctx.fillRect(screenX + TILE_SIZE/2 - 2, screenY + TILE_SIZE/2 - 1, 10, 2);
                    }
                    if (road.type === 'vertical' && road.y % 2 === 0) {
                        ctx.fillStyle = '#ffff00';
                        ctx.fillRect(screenX + TILE_SIZE/2 - 1, screenY + TILE_SIZE/2 - 2, 2, 10);
                    }
                }
            });

            // Draw objects
            worldObjects.forEach(obj => {
                if (obj.hidden) return;
                const size = obj.size || 1;
                const screenX = (obj.x - camera.x) * TILE_SIZE;
                const screenY = (obj.y - camera.y) * TILE_SIZE;
                
                if (screenX > -TILE_SIZE*size && screenX < canvas.width && screenY > -TILE_SIZE*size && screenY < canvas.height) {
                    ctx.font = `${TILE_SIZE * size * 0.9}px Arial`;
                    ctx.fillText(obj.emoji, screenX, screenY + TILE_SIZE * size * 0.85);
                }
            });

            // Draw NPCs
            npcs.forEach(npc => {
                const screenX = (npc.x - camera.x) * TILE_SIZE;
                const screenY = (npc.y - camera.y) * TILE_SIZE;
                
                if (screenX > -TILE_SIZE && screenX < canvas.width && screenY > -TILE_SIZE && screenY < canvas.height) {
                    ctx.font = `${TILE_SIZE * 0.9}px Arial`;
                    ctx.fillText(npc.emoji, screenX, screenY + TILE_SIZE * 0.85);
                }
            });

            // Draw player
            const screenX = (player.x - camera.x) * TILE_SIZE;
            const screenY = (player.y - camera.y) * TILE_SIZE;
            ctx.font = `${TILE_SIZE * 0.9}px Arial`;
            ctx.fillText(player.emoji, screenX, screenY + TILE_SIZE * 0.85);

            drawMinimap();
        }

        function drawMinimap() {
            const scale = 2.5;
            minimapCtx.fillStyle = 'rgba(0, 50, 0, 0.8)';
            minimapCtx.fillRect(0, 0, 150, 150);

            minimapCtx.fillStyle = '#666';
            roads.forEach(road => {
                minimapCtx.fillRect(road.x * scale, road.y * scale, scale, scale);
            });

            minimapCtx.fillStyle = '#888';
            worldObjects.forEach(obj => {
                if (obj.type === 'house' || obj.type === 'building' || obj.type === 'church' || obj.type === 'supermarket') {
                    minimapCtx.fillRect(obj.x * scale, obj.y * scale, scale * 2, scale * 2);
                }
                if (obj.type === 'hospital') {
                    minimapCtx.fillStyle = '#ff0000';
                    minimapCtx.fillRect(obj.x * scale, obj.y * scale, scale * 3, scale * 3);
                    minimapCtx.fillStyle = '#888';
                }
            });

            minimapCtx.fillStyle = '#00ff00';
            minimapCtx.fillRect(player.x * scale - 1, player.y * scale - 1, scale + 2, scale + 2);
        }

        function updateCamera() {
            camera.x = player.x - canvas.width / TILE_SIZE / 2;
            camera.y = player.y - canvas.height / TILE_SIZE / 2;
            
            camera.x = Math.max(0, Math.min(camera.x, WORLD_WIDTH - canvas.width / TILE_SIZE));
            camera.y = Math.max(0, Math.min(camera.y, WORLD_HEIGHT - canvas.height / TILE_SIZE));
        }

        function checkNearbyObjects() {
            nearObject = null;
            const checkDistance = 3;

            for (let npc of npcs) {
                const dx = Math.abs(player.x - npc.x);
                const dy = Math.abs(player.y - npc.y);
                const distance = Math.sqrt(dx * dx + dy * dy);

                if (distance < checkDistance) {
                    nearObject = npc;
                    document.getElementById('actionBtn').style.display = 'block';
                    document.getElementById('actionBtn').textContent = `Press E - Talk to ${npc.name}`;
                    return;
                }
            }

            for (let obj of worldObjects) {
                if (obj.hidden) continue;
                const dx = Math.abs(player.x - obj.x);
                const dy = Math.abs(player.y - obj.y);
                const distance = Math.sqrt(dx * dx + dy * dy);

                if (distance < checkDistance) {
                    nearObject = obj;
                    document.getElementById('actionBtn').style.display = 'block';
                    if (obj.type === 'hospital') {
                        document.getElementById('actionBtn').textContent = `Press E - Enter Hospital (Start Work)`;
                    } else {
                        document.getElementById('actionBtn').textContent = `Press E - ${obj.name || obj.type}`;
                    }
                    return;
                }
            }

            document.getElementById('actionBtn').style.display = 'none';
        }

        function interact() {
            if (!nearObject) return;

            if (npcs.includes(nearObject)) {
                const npc = nearObject;
                if (!npc.angry) {
                    npc.angry = true;
                    const originalEmoji = npc.emoji;
                    npc.emoji = 'üò†';
                    speak("Watch your step, kid!", 1.2, 1.1);
                    setTimeout(() => {
                        npc.angry = false;
                        npc.emoji = originalEmoji;
                    }, 3000);
                }
                return;
            }

            switch(nearObject.type) {
                case 'hospital':
                    enterHospital();
                    break;

                case 'mom':
                    const momPhrases = [
                        "How was work at the hospital today, honey?",
                        "Make sure you're taking care of yourself too, doctor!",
                        "Dinner will be ready soon!",
                        "I'm so proud of you helping people!"
                    ];
                    speak(momPhrases[Math.floor(Math.random() * momPhrases.length)], 1.4, 1);
                    break;

                case 'dad':
                    const dadPhrases = [
                        "Hey doc, save any lives today?",
                        "That's my kid, the doctor!",
                        "Want to relax and watch the game?",
                        "You work too hard, take a break!"
                    ];
                    speak(dadPhrases[Math.floor(Math.random() * dadPhrases.length)], 0.8, 0.9);
                    break;

                case 'supermarket':
                    document.getElementById('shop').style.display = 'block';
                    speak("Welcome to the supermarket, Doctor!", 1.2, 1);
                    break;

                case 'church':
                    speak("Welcome to the house of worship.", 0.9, 0.8);
                    break;

                case 'ambulance':
                    speak("The ambulance is ready for emergencies!", 1.1, 1);
                    break;

                case 'car':
                case 'taxi':
                case 'suv':
                case 'sports':
                    if (!player.inVehicle) {
                        player.inVehicle = true;
                        player.emoji = nearObject.emoji;
                        player.speed = nearObject.speed || 0.4;
                        nearObject.hidden = true;
                        document.getElementById('speed').textContent = 'Driving!';
                        document.getElementById('playerIcon').textContent = nearObject.emoji;
                        speak("You're now driving!", 1, 1.2);
                    } else {
                        player.inVehicle = false;
                        player.emoji = 'üë®‚Äç‚öïÔ∏è';
                        player.speed = player.baseSpeed;
                        nearObject.hidden = false;
                        nearObject.x = player.x;
                        nearObject.y = player.y;
                        document.getElementById('speed').textContent = 'Walking';
                        document.getElementById('playerIcon').textContent = 'üë®‚Äç‚öïÔ∏è';
                        speak("You exited the vehicle.", 1, 1);
                    }
                    break;

                case 'house':
                    speak("This is a lovely home in the neighborhood!", 1.1, 1);
                    break;
            }
        }

        function buyItem(item, price) {
            if (player.money >= price) {
                player.money -= price;
                player.inventory.push(item);
                document.getElementById('money').textContent = `Money: ${player.money}`;
                document.getElementById('inventory').textContent = player.inventory.join(' ');
                speak(`You bought a ${item}!`, 1.2, 1.1);
            } else {
                speak("You don't have enough money!", 1.3, 1.2);
            }
        }

        function closeShop() {
            document.getElementById('shop').style.display = 'none';
        }

        function updatePlayer() {
            const prevX = player.x;
            const prevY = player.y;

            let speedMultiplier = 1;
            if (keys['Shift']) speedMultiplier = 2;

            if (keys['w'] || keys['ArrowUp']) {
                player.y -= player.speed * speedMultiplier;
            }
            if (keys['s'] || keys['ArrowDown']) {
                player.y += player.speed * speedMultiplier;
            }
            if (keys['a'] || keys['ArrowLeft']) {
                player.x -= player.speed * speedMultiplier;
            }
            if (keys['d'] || keys['ArrowRight']) {
                player.x += player.speed * speedMultiplier;
            }

            if (speedMultiplier > 1) {
                document.getElementById('speed').textContent = player.inVehicle ? 'Fast Driving!' : 'Running!';
            } else {
                document.getElementById('speed').textContent = player.inVehicle ? 'Driving' : 'Walking';
            }

            player.x = Math.max(0, Math.min(player.x, WORLD_WIDTH - 1));
            player.y = Math.max(0, Math.min(player.y, WORLD_HEIGHT - 1));

            for (let obj of worldObjects) {
                if (obj.hidden) continue;
                if (obj.type === 'tree' || obj.type === 'building' || obj.type === 'house' || obj.type === 'church' || obj.type === 'office') {
                    const objSize = obj.size || 1;
                    const dx = Math.abs(player.x - obj.x);
                    const dy = Math.abs(player.y - obj.y);
                    if (dx < objSize * 0.9 && dy < objSize * 0.9) {
                        player.x = prevX;
                        player.y = prevY;
                    }
                }
            }

            checkNearbyObjects();
        }

        function gameLoop() {
            if (!inHospital) {
                updatePlayer();
                updateNPCs();
                updateCamera();
                drawWorld();
            }
            requestAnimationFrame(gameLoop);
        }

        // Event listeners
        window.addEventListener('keydown', (e) => {
            keys[e.key] = true;
            if (e.key === 'e' || e.key === 'E') {
                interact();
            }
        });

        window.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        document.getElementById('actionBtn').addEventListener('click', interact);

        // Mobile controls
        document.querySelectorAll('.control-btn').forEach(btn => {
            btn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const dir = btn.dataset.dir;
                if (dir === 'up') keys['w'] = true;
                if (dir === 'down') keys['s'] = true;
                if (dir === 'left') keys['a'] = true;
                if (dir === 'right') keys['d'] = true;
            });

            btn.addEventListener('touchend', (e) => {
                e.preventDefault();
                const dir = btn.dataset.dir;
                if (dir === 'up') keys['w'] = false;
                if (dir === 'down') keys['s'] = false;
                if (dir === 'left') keys['a'] = false;
                if (dir === 'right') keys['d'] = false;
            });
        });

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

        window.buyItem = buyItem;
        window.closeShop = closeShop;
        window.exitHospital = exitHospital;
        window.closeTreatment = closeTreatment;

        // Start game
        gameLoop();
        
        setTimeout(() => {
            speak("Good morning, Doctor! Welcome to the city. Head to the hospital to start your shift and treat patients!", 1, 1);
        }, 500);
    </script>
</body>
</html>
